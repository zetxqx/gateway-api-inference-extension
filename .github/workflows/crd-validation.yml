name: CRD Validation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, labeled, unlabeled]

permissions:
  contents: read
  pull-requests: write

jobs:
  crd-validation:
    name: CRD Validation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"
          cache: true

      - name: Install crdify
        run: |
          go install sigs.k8s.io/crdify@latest

      - name: Reset Validation Approval
        if: github.event.action == 'synchronize' && contains(github.event.pull_request.labels.*.name, 'ack-breaking-changes')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ github.event.pull_request.number }} --remove-label "ack-breaking-changes"
          echo "⚠️ Removed 'ack-breaking-changes' label due to new changes. Re-approval required."

      - name: Run CRD Validation Check
        env:
          ALLOW_BREAKING: ${{ contains(github.event.pull_request.labels.*.name, 'ack-breaking-changes') && github.event.action != 'synchronize' }}
        run: |
          git fetch origin ${{ github.base_ref }}:upstream_base
          BASE_SHA=$(git rev-parse upstream_base)

          FAILED=0
          for crd in config/crd/bases/*.yaml; do
            if ! crdify "git://${BASE_SHA}?path=$crd" "git://HEAD?path=$crd"; then
              echo "❌ Incompatible change detected in $crd"
              FAILED=$((FAILED + 1))
            else
              echo "✅ $crd is valid"
            fi
          done

          if [ "$FAILED" -gt 0 ]; then
            if [[ "$ALLOW_BREAKING" == "true" ]]; then
               echo "⚠️ Validation failed with $FAILED incompatible change(s), but allowed via 'ack-breaking-changes' label."
               exit 0
            else
               echo "❌ error: Validation failed! Found $FAILED incompatible CRD change(s)."
               echo "⚠️ notice: To allow these changes, a reviewer must add the 'ack-breaking-changes' label to the PR."
               exit 1
            fi
          fi

          echo "All CRDs are compatible."
